<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProxyForge — Free VPN Generator (REALITY • sing-box • WireGuard • Shadowsocks)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { pf: { primary: '#6d28d9', ink: '#0f172a'} } } } }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    .card { @apply bg-white rounded-2xl shadow-lg border border-gray-100; }
    .field { @apply w-full px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-pf-primary; }
    .label { @apply text-sm font-medium text-gray-700; }
    .hint  { @apply text-xs text-gray-500; }
    .btn   { @apply inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl font-semibold transition active:scale-[.98]; }
    .btn-primary { @apply bg-pf-primary text-white hover:bg-purple-700; }
    .btn-ghost { @apply bg-gray-100 hover:bg-gray-200 text-gray-800; }
    .badge { @apply text-[10px] uppercase tracking-wide font-bold bg-gray-100 text-gray-600 px-2 py-1 rounded; }
    .tab { @apply px-4 py-2 rounded-xl font-semibold text-sm; }
    .tab-active { @apply bg-pf-primary text-white; }
    .tab-inactive { @apply bg-gray-100 text-gray-700 hover:bg-gray-200; }
    .outbox { @apply w-full min-h-[140px] p-3 rounded-xl border border-gray-200 bg-gray-50 font-mono text-sm; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-pf-ink">
  <header class="sticky top-0 z-10 backdrop-blur bg-white/80 border-b">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-xl bg-pf-primary/10 grid place-items-center">
          <span class="text-pf-primary text-lg">⚡</span>
        </div>
        <div>
          <h1 class="text-lg font-extrabold">ProxyForge — Free VPN Generator</h1>
          <p class="text-xs text-gray-500">VLESS REALITY • sing-box JSON • WireGuard • Shadowsocks</p>
        </div>
      </div>
      <div class="hidden sm:flex items-center gap-2 text-xs text-gray-500">
        <span class="badge">No TLS offload • Use NLB/stream</span>
        <span class="badge">Copy / Download / QR</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-6 space-y-6">
    <!-- Tabs -->
    <div class="flex flex-wrap gap-2">
      <button class="tab tab-active" id="tab-reality" onclick="switchTab('reality')">VLESS REALITY</button>
      <button class="tab tab-inactive" id="tab-singbox" onclick="switchTab('singbox')">sing-box JSON</button>
      <button class="tab tab-inactive" id="tab-wireguard" onclick="switchTab('wireguard')">WireGuard</button>
      <button class="tab tab-inactive" id="tab-ss" onclick="switchTab('ss')">Shadowsocks</button>
      <span class="ml-auto text-xs text-gray-500">Tip: fields validate live, errors are highlighted.</span>
    </div>

    <!-- REALITY BUILDER -->
    <section id="panel-reality" class="card p-4 md:p-6 space-y-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">VLESS REALITY Client Link Builder</h2>
        <span class="badge">TCP • encryption=none • security=reality</span>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="space-y-3">
          <div>
            <label class="label">Server address (domain or IP)</label>
            <input id="r_host" class="field" placeholder="edge.example.com" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label">Port</label>
              <input id="r_port" class="field" type="number" value="443" min="1" max="65535" />
            </div>
            <div>
              <label class="label">Short ID (hex, 2–16) <span class="hint">optional but recommended</span></label>
              <div class="flex gap-2">
                <input id="r_sid" class="field flex-1" placeholder="0123456789abcdef" />
                <button class="btn btn-ghost" onclick="genShortId()">Gen</button>
              </div>
            </div>
          </div>
          <div>
            <label class="label">UUID</label>
            <div class="flex gap-2">
              <input id="r_uuid" class="field flex-1" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
              <button class="btn btn-ghost" onclick="genUUID()">Gen</button>
            </div>
          </div>
          <div>
            <label class="label">Server Name (SNI) / Reality dest</label>
            <input id="r_sni" class="field" placeholder="www.microsoft.com" />
            <p class="hint">REALITY will mimic this TLS server. Common: high-reputation sites.</p>
          </div>
          <div>
            <label class="label">Server Public Key (pbk)</label>
            <input id="r_pbk" class="field" placeholder="Base64URL public key from server (xray x25519)" />
            <p class="hint">Run <code>xray x25519</code> on the server; copy the <b>public</b> key here.</p>
          </div>
        </div>
        <div class="space-y-3">
          <div class="card p-4">
            <h3 class="font-semibold mb-2">Generate</h3>
            <div class="flex flex-wrap gap-2">
              <button class="btn btn-primary" onclick="buildVless()">Build VLESS URI</button>
              <button class="btn btn-ghost" onclick="buildSingboxFromReality()">Build sing-box JSON</button>
            </div>
            <p id="r_errors" class="mt-3 text-sm text-red-600 hidden"></p>
          </div>

          <div class="space-y-3">
            <div>
              <div class="flex items-center justify-between mb-1">
                <span class="label">VLESS URI</span>
                <div class="flex gap-2">
                  <button class="btn btn-ghost" onclick="copyText('r_uri')">Copy</button>
                  <button class="btn btn-ghost" onclick="downloadText('vless.txt','r_uri')">Download</button>
                </div>
              </div>
              <textarea id="r_uri" class="outbox" readonly placeholder="vless://..."></textarea>
            </div>
            <div>
              <div class="flex items-center justify-between mb-1">
                <span class="label">QR (scan in many clients)</span>
                <button class="btn btn-ghost" onclick="renderQR('r_uri','qr_reality')">Refresh QR</button>
              </div>
              <div id="qr_reality" class="bg-white rounded-xl border grid place-items-center p-4"></div>
            </div>
          </div>
        </div>
      </div>

      <details class="mt-2">
        <summary class="cursor-pointer text-sm text-gray-600">Validation & deployment tips</summary>
        <ul class="list-disc ml-5 mt-2 text-sm text-gray-600 space-y-1">
          <li>Use a <b>Network Load Balancer</b> (TCP/UDP 443) or raw DNS to the node. Do <b>not</b> terminate TLS (no ALB/HTTP proxy).</li>
          <li>Server must run Xray with <code>security: "reality"</code>, a valid <code>dest</code> (e.g., <code>www.microsoft.com:443</code>), and a non-empty <code>shortId</code> list.</li>
          <li>Client needs <b>pbk</b> (public key), <b>sni</b> (server name), and matching <b>sid</b> (shortId). UUID is the VLESS credential.</li>
        </ul>
      </details>
    </section>

    <!-- SING-BOX JSON (can also be built from REALITY form) -->
    <section id="panel-singbox" class="card p-4 md:p-6 space-y-4 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">sing-box Client JSON</h2>
        <span class="badge">VLESS REALITY (tcp)</span>
      </div>
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="space-y-3">
          <div>
            <label class="label">Server</label>
            <input id="s_host" class="field" placeholder="edge.example.com" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label">Port</label>
              <input id="s_port" class="field" type="number" value="443" />
            </div>
            <div>
              <label class="label">UUID</label>
              <div class="flex gap-2">
                <input id="s_uuid" class="field flex-1" />
                <button class="btn btn-ghost" onclick="genUUID('s_uuid')">Gen</button>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label">SNI</label>
              <input id="s_sni" class="field" placeholder="www.microsoft.com" />
            </div>
            <div>
              <label class="label">Public Key (pbk)</label>
              <input id="s_pbk" class="field" placeholder="Base64URL" />
            </div>
          </div>
          <div>
            <label class="label">Short ID (sid)</label>
            <input id="s_sid" class="field" placeholder="0123456789abcdef" />
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-primary" onclick="buildSingbox()">Build JSON</button>
            <button class="btn btn-ghost" onclick="copyText('s_json')">Copy</button>
            <button class="btn btn-ghost" onclick="downloadText('singbox.json','s_json')">Download</button>
          </div>
        </div>
        <div>
          <textarea id="s_json" class="outbox h-[320px]" readonly></textarea>
        </div>
      </div>
    </section>

    <!-- WIREGUARD -->
    <section id="panel-wireguard" class="card p-4 md:p-6 space-y-4 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">WireGuard Client Config</h2>
        <span class="badge">Scan QR in many mobile clients</span>
      </div>
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="space-y-3">
          <div>
            <label class="label">Endpoint (host:port)</label>
            <input id="w_endpoint" class="field" placeholder="vpn.example.com:51820" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label">Server Public Key</label>
              <input id="w_spk" class="field" placeholder="server public key (base64)" />
            </div>
            <div>
              <label class="label">Client Private Key</label>
              <div class="flex gap-2">
                <input id="w_cpk" class="field flex-1" placeholder="base64 (or click Gen)" />
                <button class="btn btn-ghost" onclick="genWGKey('w_cpk')">Gen</button>
              </div>
              <p class="hint">For production, generate with <code>wg genkey</code>. This button creates a random placeholder.</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label">Address (client)</label>
              <input id="w_addr" class="field" value="10.0.0.2/32" />
            </div>
            <div>
              <label class="label">DNS</label>
              <input id="w_dns" class="field" value="1.1.1.1, 1.0.0.1" />
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label">AllowedIPs</label>
              <input id="w_allowed" class="field" value="0.0.0.0/0, ::/0" />
            </div>
            <div>
              <label class="label">PersistentKeepalive</label>
              <input id="w_keep" class="field" value="25" />
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-primary" onclick="buildWG()">Build Config</button>
            <button class="btn btn-ghost" onclick="copyText('w_conf')">Copy</button>
            <button class="btn btn-ghost" onclick="downloadText('wireguard.conf','w_conf')">Download</button>
          </div>
        </div>
        <div class="space-y-3">
          <textarea id="w_conf" class="outbox h-[240px]" readonly></textarea>
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="label">QR</span>
              <button class="btn btn-ghost" onclick="renderQR('w_conf','qr_wg')">Refresh QR</button>
            </div>
            <div id="qr_wg" class="bg-white rounded-xl border grid place-items-center p-4"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- SHADOWSOCKS -->
    <section id="panel-ss" class="card p-4 md:p-6 space-y-4 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-bold">Shadowsocks Link Builder</h2>
        <span class="badge">chacha20-ietf-poly1305 (default)</span>
      </div>
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label">Server</label>
              <input id="ss_host" class="field" placeholder="edge.example.com" />
            </div>
            <div>
              <label class="label">Port</label>
              <input id="ss_port" class="field" type="number" value="8388" />
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label">Method</label>
              <select id="ss_method" class="field">
                <option>chacha20-ietf-poly1305</option>
                <option>aes-256-gcm</option>
                <option>aes-128-gcm</option>
              </select>
            </div>
            <div>
              <label class="label">Password</label>
              <div class="flex gap-2">
                <input id="ss_pass" class="field flex-1" />
                <button class="btn btn-ghost" onclick="genPassword('ss_pass')">Gen</button>
              </div>
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-primary" onclick="buildSS()">Build Link</button>
            <button class="btn btn-ghost" onclick="copyText('ss_uri')">Copy</button>
            <button class="btn btn-ghost" onclick="downloadText('shadowsocks.txt','ss_uri')">Download</button>
          </div>
        </div>
        <div class="space-y-3">
          <textarea id="ss_uri" class="outbox" readonly placeholder="ss://..."></textarea>
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="label">QR</span>
              <button class="btn btn-ghost" onclick="renderQR('ss_uri','qr_ss')">Refresh QR</button>
            </div>
            <div id="qr_ss" class="bg-white rounded-xl border grid place-items-center p-4"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="text-xs text-gray-500 leading-relaxed">
      <p><b>Security note:</b> This page runs offline in your browser. For production automation, use your server-side generator and store secrets safely. For REALITY, never expose the server <i>private</i> key—only share the <b>public</b> key (pbk).</p>
    </section>
  </main>

  <script>
    const byId = (id) => document.getElementById(id);

    function switchTab(name){
      const panels = ['reality','singbox','wireguard','ss'];
      panels.forEach(p => {
        byId(`panel-${p}`).classList.toggle('hidden', p!==name);
        byId(`tab-${p}`).classList.toggle('tab-active', p===name);
        byId(`tab-${p}`).classList.toggle('tab-inactive', p!==name);
      });
    }

    // UUID helpers
    function genUUID(dst='r_uuid'){
      fetch('/api/v1/utils/uuid')
        .then(response => response.json())
        .then(data => byId(dst).value = data.uuid)
        .catch(() => {
          // Fallback to client-side generation
          const v = (crypto.randomUUID ? crypto.randomUUID() : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
            const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16)
          }));
          byId(dst).value = v;
        });
    }

    function genShortId(){
      fetch('/api/v1/utils/shortid')
        .then(response => response.json())
        .then(data => byId('r_sid').value = data.short_id)
        .catch(() => {
          // Fallback to client-side generation
          const len = 8 + Math.floor(Math.random()*8); // 8–15
          const hex = [...crypto.getRandomValues(new Uint8Array(len))].map(b=>('0'+(b%16).toString(16)).slice(-1)).join('');
          byId('r_sid').value = hex;
        });
    }

    function genPassword(dst){
      fetch('/api/v1/utils/password')
        .then(response => response.json())
        .then(data => byId(dst).value = data.password)
        .catch(() => {
          // Fallback to client-side generation
          const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*';
          let s='';
          for(let i=0;i<20;i++){ s += chars[Math.floor(Math.random()*chars.length)] }
          byId(dst).value = s;
        });
    }

    function genWGKey(dst){
      fetch('/api/v1/utils/wg-key')
        .then(response => response.json())
        .then(data => byId(dst).value = data.key)
        .catch(() => {
          // Fallback to client-side generation
          const bytes = new Uint8Array(32); crypto.getRandomValues(bytes);
          const b64 = btoa(String.fromCharCode(...bytes));
          byId(dst).value = b64;
        });
    }

    function showError(el, msg){ el.textContent = msg; el.classList.remove('hidden'); }
    function clearError(el){ el.textContent = ''; el.classList.add('hidden'); }

    function copyText(srcId){
      const el = byId(srcId);
      el.select && el.select();
      navigator.clipboard.writeText(el.value || el.textContent || '').then(()=>{
        toast('Copied');
      });
    }

    function downloadText(filename, srcId){
      const text = byId(srcId).value || byId(srcId).textContent || '';
      const blob = new Blob([text], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }

    function renderQR(srcId, targetId){
      const el = byId(targetId);
      el.innerHTML = '';
      const content = (byId(srcId).value || '').trim();
      if(!content){ el.innerHTML = '<div class="text-xs text-gray-400">Nothing to encode yet.</div>'; return; }
      new QRCode(el, { text: content, width: 196, height: 196, correctLevel: QRCode.CorrectLevel.M });
    }

    function isUUID(v){ return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(v); }
    function isHostname(h){ return /^(?=.{1,253}$)(?!-)[A-Za-z0-9-]{1,63}(?<!-)(\.(?!-)[A-Za-z0-9-]{1,63}(?<!-))*$/.test(h) || /\b\d{1,3}(\.\d{1,3}){3}\b/.test(h); }
    function isPBK(v){ return /^[A-Za-z0-9_-]{40,60}$/.test(v); } // rough check for base64url length
    function isHex(v){ return /^[0-9a-f]+$/i.test(v); }

    // REALITY → VLESS URI
    function buildVless(){
      const host = byId('r_host').value.trim();
      const port = parseInt(byId('r_port').value||'443',10);
      const uuid = byId('r_uuid').value.trim();
      const sni  = byId('r_sni').value.trim();
      const pbk  = byId('r_pbk').value.trim();
      const sid  = byId('r_sid').value.trim();
      const errEl = byId('r_errors');

      // validate
      if(!isHostname(host)) return showError(errEl,'Server address looks invalid.');
      if(!(port>0 && port<=65535)) return showError(errEl,'Port out of range.');
      if(!isUUID(uuid)) return showError(errEl,'UUID is invalid.');
      if(!sni) return showError(errEl,'SNI (server name) is required.');
      if(!isPBK(pbk)) return showError(errEl,'Public key (pbk) looks invalid. Paste base64url from `xray x25519`.');
      if(sid && (!isHex(sid) || sid.length<2 || sid.length>16)) return showError(errEl,'Short ID must be hex, 2–16 chars (or leave empty).');
      clearError(errEl);

      const params = new URLSearchParams({
        encryption: 'none',
        security: 'reality',
        pbk,
        sni,
        type: 'tcp'
      });
      if(sid) params.set('sid', sid);

      const uri = `vless://${uuid}@${host}:${port}?${params.toString()}#ProxyForge`;
      byId('r_uri').value = uri;
      renderQR('r_uri','qr_reality');
      toast('VLESS link ready');
    }

    // Build sing-box JSON from its panel
    function buildSingbox(){
      const host = byId('s_host').value.trim();
      const port = parseInt(byId('s_port').value||'443',10);
      const uuid = byId('s_uuid').value.trim();
      const sni  = byId('s_sni').value.trim();
      const pbk  = byId('s_pbk').value.trim();
      const sid  = byId('s_sid').value.trim();

      if(!isHostname(host)) return toast('Invalid host');
      if(!(port>0 && port<=65535)) return toast('Bad port');
      if(!isUUID(uuid)) return toast('Invalid UUID');
      if(!sni) return toast('SNI required');
      if(!isPBK(pbk)) return toast('PBK invalid');
      if(sid && (!isHex(sid) || sid.length<2 || sid.length>16)) return toast('sid must be hex 2–16 or empty');

      const json = {
        log: { level: 'info' },
        outbounds: [{
          type: 'vless',
          server: host,
          server_port: port,
          uuid,
          tls: {
            enabled: true,
            server_name: sni,
            reality: { enabled: true, public_key: pbk, short_id: sid || '' }
          },
          transport: { type: 'tcp' }
        }]
      };
      byId('s_json').value = JSON.stringify(json, null, 2);
      toast('sing-box JSON ready');
    }

    // Fast path: build sing-box using values already typed in REALITY form
    function buildSingboxFromReality(){
      byId('s_host').value = byId('r_host').value;
      byId('s_port').value = byId('r_port').value;
      byId('s_uuid').value = byId('r_uuid').value;
      byId('s_sni').value  = byId('r_sni').value;
      byId('s_pbk').value  = byId('r_pbk').value;
      byId('s_sid').value  = byId('r_sid').value;
      switchTab('singbox');
      buildSingbox();
    }

    // WireGuard
    function buildWG(){
      const endpoint = byId('w_endpoint').value.trim();
      const spk = byId('w_spk').value.trim();
      const cpk = byId('w_cpk').value.trim();
      const addr = byId('w_addr').value.trim();
      const dns  = byId('w_dns').value.trim();
      const allowed = byId('w_allowed').value.trim();
      const keep = (byId('w_keep').value||'25').trim();

      if(!endpoint.includes(':')) return toast('Endpoint must be host:port');
      if(!spk) return toast('Server public key required');
      if(!cpk) return toast('Client private key required');

      const conf = `[Interface]\nPrivateKey = ${cpk}\nAddress = ${addr}\nDNS = ${dns}\n\n[Peer]\nPublicKey = ${spk}\nEndpoint = ${endpoint}\nAllowedIPs = ${allowed}\nPersistentKeepalive = ${keep}`;
      byId('w_conf').value = conf;
      renderQR('w_conf','qr_wg');
      toast('WireGuard config ready');
    }

    // Shadowsocks
    function buildSS(){
      const host = byId('ss_host').value.trim();
      const port = byId('ss_port').value.trim();
      const method = byId('ss_method').value.trim();
      const pass = byId('ss_pass').value.trim();
      if(!isHostname(host)) return toast('Invalid SS host');
      if(!(+port>0 && +port<=65535)) return toast('Bad SS port');
      if(!pass) return toast('Password required');
      const enc = btoa(`${method}:${pass}`);
      const uri = `ss://${enc}@${host}:${port}#ProxyForge`;
      byId('ss_uri').value = uri;
      renderQR('ss_uri','qr_ss');
      toast('Shadowsocks link ready');
    }

    // Mini toast
    let toastTimer;
    function toast(msg){
      clearTimeout(toastTimer);
      let el = document.getElementById('pf_toast');
      if(!el){
        el = document.createElement('div');
        el.id='pf_toast';
        el.className='fixed bottom-4 left-1/2 -translate-x-1/2 bg-black text-white px-4 py-2 rounded-xl shadow-lg opacity-0 transition';
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.classList.remove('opacity-0');
      el.classList.add('opacity-100');
      toastTimer = setTimeout(()=>{ el.classList.add('opacity-0'); }, 1600);
    }

    // Sensible defaults
    window.addEventListener('DOMContentLoaded', () => {
      genUUID('r_uuid');
      byId('r_port').value = 443;
      byId('s_port').value = 443;
    });
  </script>
</body>
</html>
